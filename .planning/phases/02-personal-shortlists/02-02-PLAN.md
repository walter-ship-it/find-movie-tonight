---
phase: 02-personal-shortlists
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/components/movie-card.tsx
  - src/components/movie-table.tsx
  - src/App.tsx
autonomous: false

must_haves:
  truths:
    - "User can add a movie to their shortlist by clicking a heart icon in browse view"
    - "User can remove a movie from their shortlist by clicking the heart icon again"
    - "Heart icon shows filled state for shortlisted movies, outline for non-shortlisted"
    - "User can switch between Browse and My Shortlist views"
    - "My Shortlist view shows all shortlisted movies with full details (ratings, runtime, platforms)"
    - "Anon users see a sign-in prompt when attempting to shortlist"
    - "Shortlist view uses existing MovieTable (desktop) and MovieCard (mobile) components"
  artifacts:
    - path: "src/components/movie-card.tsx"
      provides: "Heart toggle button on mobile movie cards"
      contains: "useShortlist"
    - path: "src/components/movie-table.tsx"
      provides: "Heart toggle button on desktop table rows"
      contains: "useShortlist"
    - path: "src/App.tsx"
      provides: "Browse/Shortlist view switcher and shortlist data fetching"
      contains: "useShortlist"
  key_links:
    - from: "src/components/movie-card.tsx"
      to: "src/contexts/shortlist-context.tsx"
      via: "useShortlist() hook for toggle and state"
      pattern: "useShortlist\\(\\)"
    - from: "src/components/movie-table.tsx"
      to: "src/contexts/shortlist-context.tsx"
      via: "useShortlist() hook for toggle and state"
      pattern: "useShortlist\\(\\)"
    - from: "src/App.tsx"
      to: "src/contexts/shortlist-context.tsx"
      via: "useShortlist() for shortlistedIds to filter movies"
      pattern: "useShortlist\\(\\)"
    - from: "src/App.tsx"
      to: "supabase shortlist + movies join"
      via: "fetch shortlist movies with full details"
      pattern: "supabase.*from.*shortlist|supabase.*rpc"
---

<objective>
Add shortlist toggle buttons to movie cards/table and a Browse/Shortlist view switcher to App.tsx so users can build and view their personal shortlist.

Purpose: This is the user-facing layer of Phase 2. After Plan 01 established the data foundation, this plan wires up the UI so users can actually add, remove, and view shortlisted movies. Completes all Phase 2 success criteria.

Output: Updated MovieCard, MovieTable, and App.tsx with shortlist UI.
</objective>

<execution_context>
@/Users/walterjooste/.claude/get-shit-done/workflows/execute-plan.md
@/Users/walterjooste/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-personal-shortlists/02-RESEARCH.md
@.planning/phases/02-personal-shortlists/02-01-SUMMARY.md

@src/App.tsx
@src/components/movie-card.tsx
@src/components/movie-table.tsx
@src/lib/supabase.ts
@src/contexts/shortlist-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add shortlist heart toggle to MovieCard and MovieTable</name>
  <files>src/components/movie-card.tsx, src/components/movie-table.tsx</files>
  <action>
Add a heart toggle button to both MovieCard (mobile) and MovieTable (desktop) that lets authenticated users add/remove movies from their shortlist.

**MovieCard (`src/components/movie-card.tsx`):**

1. Import `useShortlist` from `@/contexts/shortlist-context` and `useAuth` from `@/contexts/auth-context`.
2. Inside the component, call `const { isShortlisted, toggleShortlist } = useShortlist()` and `const { user } = useAuth()`.
3. Add a heart button positioned in the top-right corner of the card (absolute positioned within the existing card structure). Place it after the poster/details flex container but still inside the CardContent.
4. Heart button behavior:
   - If user is authenticated: call `toggleShortlist(movie.id)` on click.
   - If user is NOT authenticated: the parent (App.tsx) will handle showing the auth modal. Pass an optional `onAuthRequired` callback prop. If provided AND user is null, call `onAuthRequired()` instead of toggleShortlist.
5. Heart visual:
   - Use an SVG heart icon (inline SVG, not a lucide import -- keep it simple).
   - Filled heart (solid pink/red) when `isShortlisted(movie.id)` is true.
   - Outline heart (muted foreground) when not shortlisted.
   - Transition animation on state change: `transition-all duration-300`.
   - Add a subtle scale effect on hover: `hover:scale-110`.
6. Add `aria-label` for accessibility: "Add to shortlist" / "Remove from shortlist".
7. Prevent the click from bubbling to card interactions: `e.stopPropagation()`.
8. Position: top-right of the card, using `absolute top-2 right-2` within a relative container. The card's outer div already has `class="group relative"` so place the button there.

**MovieTable (`src/components/movie-table.tsx`):**

1. Import `useShortlist` from `@/contexts/shortlist-context` and `useAuth` from `@/contexts/auth-context`.
2. Inside the component, call `const { isShortlisted, toggleShortlist } = useShortlist()` and `const { user } = useAuth()`.
3. Add a new narrow column as the FIRST column in the table (before Poster):
   - Header: empty or a small heart icon (purely decorative).
   - Width: `w-[40px]`.
4. Each row gets a heart button in that first cell:
   - Same filled/outline logic as MovieCard.
   - Same auth check with optional `onAuthRequired` prop.
   - Smaller icon size for table context (16x16 or `h-4 w-4`).
5. Heart styling: use the same pink/red color scheme as the neon theme. `text-pink-500` for filled, `text-muted-foreground` for outline. Hover: `hover:text-pink-400`.
6. Add `aria-label` for accessibility.

**Both components:** Add an optional `onAuthRequired?: () => void` prop to the props interface. The actual auth modal trigger will be wired up in App.tsx (Task 2).

Follow existing conventions: `cn()` for class merging, Tailwind utilities, 2-space indentation.
  </action>
  <verify>
`npm run build` passes with zero TypeScript errors. Both MovieCard and MovieTable accept optional `onAuthRequired` prop. Both components import and use `useShortlist`. Heart SVG renders in both components.
  </verify>
  <done>MovieCard shows a heart toggle in the top-right corner. MovieTable shows a heart toggle as the first column. Both use ShortlistContext for state and support onAuthRequired callback for anon users.</done>
</task>

<task type="auto">
  <name>Task 2: Add Browse/Shortlist view switcher to App.tsx</name>
  <files>src/App.tsx</files>
  <action>
Update App.tsx to add a view switcher between "Browse" and "My Shortlist" views, and wire up shortlist data fetching for the shortlist view.

**1. View state:**
Add a `view` state: `const [view, setView] = useState<'browse' | 'shortlist'>('browse')`.

**2. Import useShortlist:**
`import { useShortlist } from '@/contexts/shortlist-context'`
Destructure: `const { shortlistedIds, loading: shortlistLoading } = useShortlist()`

**3. View switcher UI:**
Add a tab-style switcher in the header area, between the title row and the controls glass-card. Place it in a new row. Style:
- Two buttons/tabs: "Browse" and "My Shortlist (N)" where N is `shortlistedIds.size`.
- Use the glass-card aesthetic with a pill/tab indicator.
- Active tab: `bg-primary/20 text-primary` or similar neon highlight.
- Inactive tab: `text-muted-foreground hover:text-foreground`.
- Only show the switcher when user is logged in. Anon users see browse only.
- Rounded pill buttons inside a glass-card container, similar to the existing controls row.

**4. Shortlist movies data:**
When view is 'shortlist' and user is logged in, fetch full movie details for shortlisted movies. Two approaches -- use the simpler one:
- Filter the already-loaded `movies` array by checking if `shortlistedIds.has(movie.id)`. This works because the browse view already has full Movie objects loaded.
- Compute this as a useMemo: `const shortlistMovies = useMemo(() => movies.filter(m => shortlistedIds.has(m.id)), [movies, shortlistedIds])`.
- NOTE: This means the shortlist view only shows movies from the currently selected country. This is acceptable for v1 -- the user browses a country and shortlists from it.

**5. Conditional rendering based on view:**
- When `view === 'browse'`: Show existing browse UI (search, filters, movie count, MovieTable/MovieCard) -- no changes to existing behavior.
- When `view === 'shortlist'`:
  - Hide the search bar and filters (shortlist is a curated list, no need to re-filter).
  - Show a shortlist-specific header: "My Shortlist" with movie count.
  - If shortlistMovies is empty: Show an empty state: "Your shortlist is empty. Browse movies and tap the heart icon to add them."
  - If shortlistMovies has items: Render using the SAME MovieTable (desktop) and MovieCard (mobile) components, passing `shortlistMovies` instead of `processedMovies`.
  - Pass the existing `sortConfig` and `onSortChange` to MovieTable so the shortlist view is also sortable.

**6. Wire onAuthRequired:**
Pass `onAuthRequired={() => setShowAuth('login')}` prop to both MovieCard and MovieTable instances (in both browse and shortlist views). This triggers the auth modal when an anon user clicks the heart.

**7. Movie count update:**
In browse view, the existing movie count text stays the same.
In shortlist view, show: "{N} movie(s) in your shortlist".

Follow existing patterns in App.tsx: useMemo for derived data, cn() for classes, glass-card styling, responsive show/hide with `hidden md:block` / `md:hidden`.
  </action>
  <verify>
`npm run build` passes with zero TypeScript errors. App.tsx imports and uses useShortlist. View switcher renders two tabs (only when logged in). Browse view shows existing movie list with heart toggles. Shortlist view shows filtered movies. MovieCard and MovieTable receive onAuthRequired prop.
  </verify>
  <done>Users can switch between Browse and My Shortlist views. Browse view shows heart toggles on all movies. Shortlist view shows only shortlisted movies using the same MovieTable/MovieCard components. Anon users get sign-in prompt on heart click.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete shortlist feature end-to-end</name>
  <files>n/a</files>
  <action>
Human verifies the complete personal shortlist feature works end-to-end.

Pre-requisite: Apply the migration SQL file in Supabase Dashboard SQL Editor (paste contents of `supabase/migrations/20260216000001_shortlist_table.sql` and run).

Then test the feature at http://localhost:5173:
1. Sign in with your account
2. Verify the Browse/My Shortlist tab switcher appears
3. In Browse view, verify each movie has a heart icon (outline state)
4. Click a heart -- it should fill immediately (optimistic update)
5. Switch to My Shortlist tab -- the hearted movie should appear
6. Click the filled heart to remove -- movie disappears from shortlist
7. Switch to Browse -- heart is outline again
8. Heart 2-3 movies, refresh page -- hearts persist
9. Sign out and back in -- shortlist intact
10. (Optional) Test as anon: click heart triggers sign-in prompt
  </action>
  <verify>All 10 test steps pass. No console errors. Hearts toggle instantly. Shortlist count updates in tab.</verify>
  <done>Phase 2 feature verified working end-to-end by human.</done>
</task>

</tasks>

<verification>
- All 4 Phase 2 success criteria met:
  1. User can add a movie to shortlist (heart toggle in browse view)
  2. User can remove a movie from shortlist (heart toggle again)
  3. User can view shortlist with full details (My Shortlist view with MovieTable/MovieCard)
  4. Shortlist persists across sessions/devices (Supabase database storage)
- `npm run build` passes
- No new npm dependencies
- Anon browsing still works (hearts show but trigger sign-in prompt)
</verification>

<success_criteria>
- Heart icons visible on every movie in both desktop table and mobile cards
- Clicking heart toggles shortlist state instantly (optimistic)
- My Shortlist view shows only shortlisted movies with all details
- Shortlist count shown in tab switcher
- Data persists across page refresh and sign-out/sign-in
- Anon users prompted to sign in when clicking heart
- Build passes with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-personal-shortlists/02-02-SUMMARY.md`
</output>
