---
phase: 02-personal-shortlists
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260216000001_shortlist_table.sql
  - src/contexts/shortlist-context.tsx
  - src/main.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Shortlist table and RLS policies"
    dashboard_config:
      - task: "Run migration SQL in SQL Editor"
        location: "Supabase Dashboard -> SQL Editor -> New query -> paste contents of supabase/migrations/20260216000001_shortlist_table.sql -> Run"

must_haves:
  truths:
    - "Shortlist table exists with user_id + movie_id unique constraint"
    - "RLS allows users to insert/delete own entries only"
    - "RLS allows users to read own + partner shortlist entries"
    - "ShortlistContext provides shortlistedIds Set and toggleShortlist function"
    - "Optimistic updates give instant UI feedback on toggle"
    - "Shortlist state loads on auth and clears on sign-out"
  artifacts:
    - path: "supabase/migrations/20260216000001_shortlist_table.sql"
      provides: "Shortlist table with RLS policies"
      contains: "create table public.shortlist"
    - path: "src/contexts/shortlist-context.tsx"
      provides: "ShortlistProvider and useShortlist hook"
      exports: ["ShortlistProvider", "useShortlist"]
    - path: "src/main.tsx"
      provides: "ShortlistProvider wrapping the app"
      contains: "ShortlistProvider"
  key_links:
    - from: "src/contexts/shortlist-context.tsx"
      to: "supabase shortlist table"
      via: "supabase.from('shortlist').select/insert/delete"
      pattern: "supabase\\.from\\(['\"]shortlist['\"]\\)"
    - from: "src/contexts/shortlist-context.tsx"
      to: "src/contexts/auth-context.tsx"
      via: "useAuth() for user.id"
      pattern: "useAuth\\(\\)"
    - from: "src/main.tsx"
      to: "src/contexts/shortlist-context.tsx"
      via: "ShortlistProvider in component tree"
      pattern: "ShortlistProvider"
---

<objective>
Create the shortlist database table with RLS policies and a ShortlistContext provider that manages shortlist state with optimistic updates.

Purpose: Establishes the data foundation for personal shortlists -- both the persistent storage (Supabase table) and the client-side state management (React context). This enables Plan 02 to wire up UI controls without worrying about data plumbing.

Output: Migration SQL file, ShortlistContext with useShortlist hook, updated main.tsx provider tree.
</objective>

<execution_context>
@/Users/walterjooste/.claude/get-shit-done/workflows/execute-plan.md
@/Users/walterjooste/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-personal-shortlists/02-RESEARCH.md

@src/lib/supabase.ts
@src/contexts/auth-context.tsx
@src/main.tsx
@supabase/migrations/20260211000002_profiles_table.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shortlist table migration with RLS policies</name>
  <files>supabase/migrations/20260216000001_shortlist_table.sql</files>
  <action>
Create the shortlist table migration SQL file. Follow the exact pattern from `supabase/migrations/20260211000002_profiles_table.sql` (section headers, security definer pattern, etc.).

Table definition:
```sql
create table public.shortlist (
  id uuid primary key default gen_random_uuid(),
  user_id uuid not null references public.profiles(id) on delete cascade,
  movie_id uuid not null references public.movies(id) on delete cascade,
  created_at timestamptz default now(),
  unique(user_id, movie_id)
);
```

Enable RLS: `alter table public.shortlist enable row level security;`

RLS policies (4 total):
1. SELECT own entries: `using ((select auth.uid()) = user_id)` for authenticated role
2. SELECT partner entries: `using (user_id = public.get_my_partner_id())` for authenticated role -- reuse existing helper function to avoid RLS recursion (forward-compatible for Phase 3)
3. INSERT own entries: `with check ((select auth.uid()) = user_id)` for authenticated role
4. DELETE own entries: `using ((select auth.uid()) = user_id)` for authenticated role

Add an index on user_id for fast lookups: `create index idx_shortlist_user_id on public.shortlist(user_id);`

Use the same comment/section-header style as existing migrations. Include a migration header comment with date and description.

NOTE: This migration will be applied manually via the Supabase SQL Editor dashboard (not via CLI), per established project convention.
  </action>
  <verify>
File exists at `supabase/migrations/20260216000001_shortlist_table.sql`. SQL is syntactically valid (no obvious syntax errors). Contains: CREATE TABLE, ENABLE ROW LEVEL SECURITY, 4 CREATE POLICY statements, CREATE INDEX. References `public.get_my_partner_id()` in partner SELECT policy.
  </verify>
  <done>Migration file ready for manual application. Contains shortlist table, RLS policies for own + partner read access, own-only insert/delete, and user_id index.</done>
</task>

<task type="auto">
  <name>Task 2: Create ShortlistContext provider with optimistic updates</name>
  <files>src/contexts/shortlist-context.tsx, src/main.tsx</files>
  <action>
Create `src/contexts/shortlist-context.tsx` following the exact pattern of `src/contexts/auth-context.tsx` (createContext, Provider component, custom hook with error boundary).

**ShortlistContext interface:**
```typescript
interface ShortlistContextType {
  shortlistedIds: Set<string>       // Set of movie IDs the user has shortlisted
  toggleShortlist: (movieId: string) => Promise<void>
  isShortlisted: (movieId: string) => boolean
  loading: boolean                   // True while initial fetch in progress
}
```

**ShortlistProvider implementation:**

1. Import `useAuth` from `@/contexts/auth-context` and `supabase` from `@/lib/supabase`.

2. State: `shortlistedIds` as `Set<string>` (useState), `loading` as boolean.

3. On mount / when `user` changes:
   - If user is null: clear shortlistedIds to empty Set, set loading false, return.
   - If user exists: fetch shortlisted movie IDs via `supabase.from('shortlist').select('movie_id').eq('user_id', user.id)`. Build a Set from the returned movie_id values. Set loading false.
   - Wrap in try/catch -- on error, console.error and set empty Set.

4. `isShortlisted(movieId)`: return `shortlistedIds.has(movieId)`.

5. `toggleShortlist(movieId)`:
   - If no user, return early (caller handles sign-in prompt).
   - Determine current state: `const wasShortlisted = shortlistedIds.has(movieId)`.
   - **Optimistic update:** Immediately update the Set (add or remove movieId). Create a new Set to trigger React re-render.
   - **Server operation:**
     - If adding: `supabase.from('shortlist').insert({ user_id: user.id, movie_id: movieId })`.
     - If removing: `supabase.from('shortlist').delete().eq('user_id', user.id).eq('movie_id', movieId)`.
   - **On error:** Revert the optimistic update (restore previous Set), console.error the error.

6. Export `ShortlistProvider` and `useShortlist` hook (with the same "must be used within Provider" error pattern as useAuth).

**Update `src/main.tsx`:**

Add `ShortlistProvider` to the provider tree, nested inside `AuthProvider` (since it depends on useAuth) but wrapping `InviteProvider` and `App`:

```tsx
<AuthProvider>
  <ShortlistProvider>
    <InviteProvider>
      <App />
    </InviteProvider>
  </ShortlistProvider>
</AuthProvider>
```

Follow existing code conventions: named exports, 2-space indentation, `@/` import paths, no JSDoc.
  </action>
  <verify>
`npm run build` completes with zero TypeScript errors. `src/contexts/shortlist-context.tsx` exports ShortlistProvider and useShortlist. `src/main.tsx` includes ShortlistProvider in the component tree inside AuthProvider.
  </verify>
  <done>ShortlistContext provides shortlistedIds Set, toggleShortlist with optimistic updates, isShortlisted helper, and loading state. Provider is mounted in the app component tree. Build passes.</done>
</task>

</tasks>

<verification>
- Migration file exists and contains valid SQL for shortlist table + 4 RLS policies + index
- ShortlistContext exports ShortlistProvider and useShortlist
- ShortlistProvider is in main.tsx provider tree (inside AuthProvider)
- `npm run build` passes with zero errors
- No new npm dependencies added
</verification>

<success_criteria>
- Shortlist table migration file is ready for manual SQL Editor application
- ShortlistContext provides reactive shortlist state with optimistic toggle
- Build succeeds with zero TypeScript errors
- Context clears state when user signs out and loads state when user signs in
</success_criteria>

<output>
After completion, create `.planning/phases/02-personal-shortlists/02-01-SUMMARY.md`
</output>
