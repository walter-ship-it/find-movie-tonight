---
phase: 01-authentication-foundation
plan: 03
type: execute
wave: 3
depends_on: ["01-01", "01-02"]
files_modified:
  - src/components/auth/partner-link.tsx
  - src/App.tsx
  - supabase/migrations/20260211000003_get_available_partners.sql
autonomous: false

must_haves:
  truths:
    - "User can see their current partner status (linked or unlinked)"
    - "User can link with their partner (the only other user)"
    - "User can unlink from their partner"
    - "Partner linking is bidirectional (both profiles updated)"
    - "Full auth flow works end-to-end: sign up, sign in, sign out, magic link, partner link"
  artifacts:
    - path: "src/components/auth/partner-link.tsx"
      provides: "Partner status display with link/unlink actions"
      exports: ["PartnerLink"]
    - path: "src/App.tsx"
      provides: "Partner link component accessible from authenticated UI"
      contains: "PartnerLink"
    - path: "supabase/migrations/20260211000003_get_available_partners.sql"
      provides: "RPC function to list linkable users"
      contains: "get_available_partners"
  key_links:
    - from: "src/components/auth/partner-link.tsx"
      to: "supabase rpc link_partner"
      via: "calls database function for bidirectional linking"
      pattern: "supabase\\.rpc\\(.*link_partner"
    - from: "src/components/auth/partner-link.tsx"
      to: "supabase rpc unlink_partner"
      via: "calls database function for bidirectional unlinking"
      pattern: "supabase\\.rpc\\(.*unlink_partner"
    - from: "src/components/auth/partner-link.tsx"
      to: "public.profiles"
      via: "queries profiles to find unlinked users"
      pattern: "supabase\\.from\\(.*profiles"
---

<objective>
Build the partner linking feature (AUTH-04) and verify the complete authentication flow works end-to-end. After this plan, the entire Phase 1 is complete: users can create accounts, sign in via password or magic link, maintain sessions, and link their account to their partner's account.

Purpose: Delivers AUTH-04 (partner linking) and provides human verification that all 5 Phase 1 success criteria are met.
Output: Partner link component, updated App.tsx, human-verified auth flow.
</objective>

<execution_context>
@/Users/walterjooste/.claude/get-shit-done/workflows/execute-plan.md
@/Users/walterjooste/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-foundation/01-RESEARCH.md
@.planning/phases/01-authentication-foundation/01-01-SUMMARY.md
@.planning/phases/01-authentication-foundation/01-02-SUMMARY.md
@src/App.tsx
@src/contexts/auth-context.tsx
@src/components/auth/user-menu.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build partner linking component and integrate into app</name>
  <files>
    src/components/auth/partner-link.tsx
    src/App.tsx
    supabase/migrations/20260211000003_get_available_partners.sql
  </files>
  <action>
**Create `supabase/migrations/20260211000003_get_available_partners.sql`:**

Add a `security definer` function that returns available (unlinked) partners. This is needed because RLS on profiles only allows reading own profile and partner's profile -- before linking, you can't see other users.

```sql
create or replace function public.get_available_partners()
returns table(id uuid, display_name text)
language plpgsql
security definer set search_path = ''
as $$
begin
  return query
    select p.id, p.display_name
    from public.profiles p
    where p.id != auth.uid()
    and p.partner_id is null;
end;
$$;
```

Apply with `npx supabase db push`.

**Create `src/components/auth/partner-link.tsx` -- PartnerLink:**

This component shows the user's partner status and lets them link/unlink. For a 2-user app, the UX is simple: show the only other user and offer to link, OR show the current partner and offer to unlink.

Uses `useAuth()` to get current user. On mount, fetches state:
1. Query own profile: `supabase.from('profiles').select('partner_id').eq('id', user.id).single()`
2. If `partner_id` is not null: query partner profile: `supabase.from('profiles').select('display_name').eq('id', partner_id).single()` -- shows "Linked with [name]" + Unlink button
3. If `partner_id` is null: call `supabase.rpc('get_available_partners')` -- if returns result, shows "[name] is available -- Link?" button. If empty, shows "Your partner hasn't signed up yet."

Component states:
1. **Loading**: Fetching profile/partner data
2. **Linked**: Shows "Linked with [partner name]" + "Unlink" button (calls `supabase.rpc('unlink_partner')`)
3. **Unlinked, partner available**: Shows "[Partner name] is available" + "Link" button (calls `supabase.rpc('link_partner', { target_user_id: partnerId })`)
4. **Unlinked, no partner**: Shows "Your partner hasn't signed up yet"
5. **Error**: Shows error message

After link/unlink actions, refetch state to update display.

Style with glass-card, existing Button component, match app aesthetic.

**Modify `src/App.tsx` (or `src/components/auth/user-menu.tsx`):**
- Import `PartnerLink` from `@/components/auth/partner-link`
- Show PartnerLink when user is authenticated, in the user menu area. The simplest approach: include it as part of the user menu section in the header, below the display name. Alternatively, add it inside UserMenu component itself -- choose whichever results in cleaner code.
  </action>
  <verify>
Run `npm run build` -- zero TypeScript errors. Verify partner-link.tsx exists and exports PartnerLink. Verify App.tsx (or user-menu.tsx) imports and renders PartnerLink for authenticated users. Verify the get_available_partners migration file exists.
  </verify>
  <done>
PartnerLink component shows partner status (linked/unlinked/no partner available). Link and unlink actions call the correct Supabase RPC functions. Component is accessible from the authenticated user interface. Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete authentication flow end-to-end</name>
  <files>none</files>
  <action>
Human verification of the complete Phase 1 authentication system. All automated work is complete -- this task confirms everything works from the user's perspective.
  </action>
  <verify>
Run `npm run dev` to start the dev server and test the following scenarios:

**1. Anonymous browsing preserved:**
- Open the app in a fresh incognito window
- Verify movies load and display normally
- Verify search, filters, and sort all work
- Expected: App functions identically to before auth was added

**2. Sign up (AUTH-01):**
- Click "Sign in" button in the header
- Switch to "Sign up" form
- Enter a display name, email, and password
- Submit the form
- Expected: Account created, user is signed in (if email confirmation disabled), header shows display name
- NOTE: If email confirmation is enabled in Supabase dashboard, disable it first (Dashboard -> Auth -> Providers -> Email -> toggle off "Confirm email")

**3. Sign out and sign in with password:**
- Click "Sign out"
- Expected: Returns to anonymous state, "Sign in" button reappears
- Click "Sign in", enter email and password
- Expected: Signed in, header shows display name

**4. Session persistence (AUTH-03):**
- While signed in, refresh the browser (Cmd+R / F5)
- Expected: Still signed in, no flash of anonymous state (brief loading is OK)
- Close the tab, open a new tab to the same URL
- Expected: Still signed in

**5. Magic link sign-in (AUTH-02):**
- Sign out first
- Click "Sign in", enter email, click "Send magic link"
- Expected: "Check your email" message shown
- Check email inbox, click the magic link
- Expected: App opens and you are signed in
- NOTE: Free tier rate limit is 2 emails/hour

**6. Partner linking (AUTH-04):**
- Create a second account (different email) in another browser/incognito window
- In the first account, find the partner link feature
- Expected: Shows the second user as available to link
- Click "Link"
- Expected: Both accounts now show as linked
- Test "Unlink" -- should disconnect both

**7. Movie browsing while authenticated:**
- While signed in, browse movies, search, filter, sort
- Expected: All features work identically to anonymous browsing
  </verify>
  <done>
Human has approved: all 4 requirements (AUTH-01 through AUTH-04) verified working. Anonymous browsing preserved. Session persistence confirmed. Partner linking works bidirectionally.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` compiles with zero errors
2. PartnerLink component handles all states: loading, linked, unlinked with available partner, unlinked with no partner
3. Partner link/unlink calls Supabase RPC functions
4. get_available_partners database function exists
5. Human verification confirms all 5 phase success criteria:
   - User can create account (AUTH-01)
   - User can sign in via magic link (AUTH-02)
   - Session persists across refresh (AUTH-03)
   - User can link partner account (AUTH-04)
   - Anonymous browsing still works
</verification>

<success_criteria>
- All 4 requirements (AUTH-01 through AUTH-04) are verified working
- Anonymous browsing is confirmed preserved
- Session persistence is confirmed across refresh
- Partner linking works bidirectionally
- Human has approved the complete flow
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-foundation/01-03-SUMMARY.md`
</output>
