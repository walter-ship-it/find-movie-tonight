---
phase: 01-authentication-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/20260211000001_rls_anon_movies.sql
  - supabase/migrations/20260211000002_profiles_table.sql
  - src/contexts/auth-context.tsx
  - src/main.tsx
autonomous: true
user_setup:
  - service: supabase
    why: "Magic link redirect URLs must be configured before magic links work"
    dashboard_config:
      - task: "Add localhost redirect URL"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Additional Redirect URLs -> add http://localhost:5173/**"
      - task: "Verify Site URL"
        location: "Supabase Dashboard -> Authentication -> URL Configuration -> Site URL should be your production Vercel URL"
      - task: "Disable email confirmation for development"
        location: "Supabase Dashboard -> Authentication -> Providers -> Email -> toggle OFF 'Confirm email'"

must_haves:
  truths:
    - "Anonymous users can still browse movies after RLS is enabled"
    - "Authenticated users can still browse movies after RLS is enabled"
    - "A profile row is auto-created when a new user signs up"
    - "React app has auth state available via useAuth hook"
    - "Auth state loading is handled (no flash of wrong UI)"
  artifacts:
    - path: "supabase/migrations/20260211000001_rls_anon_movies.sql"
      provides: "Anon-safe RLS policies on movies table"
      contains: "create policy"
    - path: "supabase/migrations/20260211000002_profiles_table.sql"
      provides: "Profiles table with partner_id, trigger, partner linking functions, RLS policies"
      contains: "create table public.profiles"
    - path: "src/contexts/auth-context.tsx"
      provides: "AuthProvider component and useAuth hook"
      exports: ["AuthProvider", "useAuth"]
    - path: "src/main.tsx"
      provides: "App wrapped in AuthProvider"
      contains: "AuthProvider"
  key_links:
    - from: "src/contexts/auth-context.tsx"
      to: "src/lib/supabase.ts"
      via: "imports supabase client for onAuthStateChange"
      pattern: "supabase\\.auth\\.onAuthStateChange"
    - from: "src/main.tsx"
      to: "src/contexts/auth-context.tsx"
      via: "wraps App in AuthProvider"
      pattern: "<AuthProvider>"
    - from: "supabase/migrations/20260211000002_profiles_table.sql"
      to: "auth.users"
      via: "trigger on auth.users creates profile row"
      pattern: "on_auth_user_created"
---

<objective>
Create the database and React foundations for authentication: enable RLS on the movies table with anon-preserving policies, create the profiles table with partner linking support, and build the AuthContext provider that exposes auth state to the entire app.

Purpose: This plan creates the two pillars everything else depends on -- (1) a secure database layer that preserves anonymous browsing while supporting authenticated features, and (2) a React auth context that all future auth-aware components will consume.
Output: SQL migration files applied to Supabase, AuthProvider wrapping the app, useAuth hook available for all components.
</objective>

<execution_context>
@/Users/walterjooste/.claude/get-shit-done/workflows/execute-plan.md
@/Users/walterjooste/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-foundation/01-RESEARCH.md
@src/lib/supabase.ts
@src/main.tsx
@supabase/migrations/20260122000000_add_streaming_providers_and_ratings.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migrations for RLS and profiles</name>
  <files>
    supabase/migrations/20260211000001_rls_anon_movies.sql
    supabase/migrations/20260211000002_profiles_table.sql
  </files>
  <action>
Create two SQL migration files. CRITICAL ordering: anon policies BEFORE enabling RLS.

**Migration 1: `20260211000001_rls_anon_movies.sql`**
- Create a permissive SELECT policy on `public.movies` granting access to both `anon` and `authenticated` roles with `using (true)`.
- THEN enable RLS on `public.movies` with `alter table public.movies enable row level security`.
- This order is NON-NEGOTIABLE. Reversing it breaks all anonymous movie browsing.

**Migration 2: `20260211000002_profiles_table.sql`**
- Create `public.profiles` table:
  - `id uuid not null references auth.users(id) on delete cascade` (primary key)
  - `display_name text not null`
  - `partner_id uuid references public.profiles(id) on delete set null`
  - `created_at timestamptz default now()`
  - `updated_at timestamptz default now()`
- Enable RLS on profiles.
- Create RLS policies on profiles:
  - "Users can view own profile" -- authenticated, `using ((select auth.uid()) = id)`
  - "Users can view partner profile" -- authenticated, `using (id = (select partner_id from public.profiles where id = (select auth.uid())))`
  - "Users can update own profile" -- authenticated, for UPDATE, `using` and `with check` both `(select auth.uid()) = id`
- Create trigger function `public.handle_new_user()`:
  - `language plpgsql security definer set search_path = ''`
  - Inserts into `public.profiles (id, display_name)` using `new.id` and `coalesce(new.raw_user_meta_data ->> 'display_name', split_part(new.email, '@', 1))`
  - Returns new
- Create trigger `on_auth_user_created` after insert on `auth.users` for each row executing `public.handle_new_user()`
- Create `public.link_partner(target_user_id uuid)` function:
  - `security definer set search_path = ''`
  - Validates not self-linking, validates target exists
  - Sets bidirectional `partner_id` on both profiles
- Create `public.unlink_partner()` function:
  - `security definer set search_path = ''`
  - Clears `partner_id` on both current user and their partner

After creating the files, apply them to the live database:
```bash
npx supabase db push
```
If `supabase db push` is not available or errors, provide the SQL for manual execution via the Supabase SQL editor dashboard and note this in the summary.
  </action>
  <verify>
Run `npx supabase db push` (or confirm migrations are ready for manual application). Verify the app still loads and displays movies by running `npm run build` to confirm no TypeScript errors. If the database is accessible, verify with a quick query that movies are still readable.
  </verify>
  <done>
Two migration files exist. RLS is enabled on movies with anon SELECT policy. Profiles table exists with RLS policies, auto-create trigger, and partner linking functions. Anonymous movie browsing is NOT broken.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AuthContext provider and wrap the app</name>
  <files>
    src/contexts/auth-context.tsx
    src/main.tsx
  </files>
  <action>
**Create `src/contexts/auth-context.tsx`:**

Build an AuthProvider component and useAuth hook following the pattern from the research doc (Pattern 1). Key implementation details:

- Import `User`, `Session`, `AuthChangeEvent` from `@supabase/supabase-js`
- Import `supabase` from `@/lib/supabase`
- Define `AuthContextType` interface with: `user: User | null`, `session: Session | null`, `loading: boolean`, `signOut: () => Promise<void>`
- Create `AuthContext` with `createContext<AuthContextType | undefined>(undefined)`
- In `AuthProvider`:
  - Initialize `loading` to `true`
  - On mount, call `supabase.auth.getSession()` to get initial session, set user/session/loading
  - Subscribe to `supabase.auth.onAuthStateChange` -- only update state in the callback (do NOT call other Supabase methods inside the callback to avoid deadlocks per research pitfall #2)
  - Clean up subscription on unmount
  - Provide `signOut` function that calls `supabase.auth.signOut()`
- Export `useAuth` hook that throws if used outside provider
- Use named exports (not default) per codebase conventions

**Modify `src/main.tsx`:**

- Import `AuthProvider` from `@/contexts/auth-context`
- Wrap `<App />` with `<AuthProvider>` inside `<React.StrictMode>`

Do NOT add `@supabase/auth-helpers-react` or `@supabase/auth-ui-react` (both deprecated per research).
  </action>
  <verify>
Run `npm run build` -- should compile with zero errors. The app should still load and function identically (auth context provides `user: null` and `loading: false` for anonymous users). Verify by checking the build output for successful compilation.
  </verify>
  <done>
AuthProvider wraps the app. `useAuth()` hook is available returning `{ user, session, loading, signOut }`. App still works for anonymous users with no visible changes. Build succeeds with zero TypeScript errors.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` compiles successfully with zero errors
2. App loads in browser and movies display normally (anonymous browsing preserved)
3. `src/contexts/auth-context.tsx` exports `AuthProvider` and `useAuth`
4. `src/main.tsx` wraps App in AuthProvider
5. Migration files follow correct RLS ordering (policy BEFORE enable)
6. Profiles table migration includes trigger, RLS policies, and partner functions
</verification>

<success_criteria>
- Anonymous movie browsing works identically to before (RLS does not break anything)
- AuthProvider is mounted at app root
- useAuth() returns { user: null, session: null, loading: false, signOut } for anonymous visitors
- Build succeeds with zero TypeScript errors
- Database has: movies RLS enabled with anon policy, profiles table with trigger and partner functions
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-foundation/01-01-SUMMARY.md`
</output>
