---
phase: 01-authentication-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/components/auth/login-form.tsx
  - src/components/auth/signup-form.tsx
  - src/components/auth/auth-callback.tsx
  - src/components/auth/user-menu.tsx
  - src/App.tsx
autonomous: true

must_haves:
  truths:
    - "User can create an account with email, password, and display name"
    - "User can sign in with email and password"
    - "User can request a magic link via email"
    - "User is signed in after clicking magic link"
    - "User can sign out"
    - "User sees their name and a sign-out option when authenticated"
    - "Anonymous user sees a sign-in button"
    - "Session persists across browser refresh"
  artifacts:
    - path: "src/components/auth/signup-form.tsx"
      provides: "Sign-up form with email, password, display name"
      exports: ["SignUpForm"]
    - path: "src/components/auth/login-form.tsx"
      provides: "Sign-in form with password and magic link options"
      exports: ["LoginForm"]
    - path: "src/components/auth/auth-callback.tsx"
      provides: "Magic link token_hash verification handler"
      exports: ["AuthCallback"]
    - path: "src/components/auth/user-menu.tsx"
      provides: "Authenticated user menu with display name and sign-out"
      exports: ["UserMenu"]
    - path: "src/App.tsx"
      provides: "Header integration with auth state, AuthCallback mounting"
      contains: "useAuth"
  key_links:
    - from: "src/components/auth/signup-form.tsx"
      to: "supabase.auth.signUp"
      via: "form onSubmit handler"
      pattern: "supabase\\.auth\\.signUp"
    - from: "src/components/auth/login-form.tsx"
      to: "supabase.auth.signInWithPassword"
      via: "password form submit"
      pattern: "signInWithPassword"
    - from: "src/components/auth/login-form.tsx"
      to: "supabase.auth.signInWithOtp"
      via: "magic link button"
      pattern: "signInWithOtp"
    - from: "src/components/auth/auth-callback.tsx"
      to: "supabase.auth.verifyOtp"
      via: "URL token_hash parsing on mount"
      pattern: "verifyOtp.*token_hash"
    - from: "src/App.tsx"
      to: "src/contexts/auth-context.tsx"
      via: "useAuth hook for conditional header rendering"
      pattern: "useAuth\\(\\)"
---

<objective>
Build the complete auth UI: sign-up form, sign-in form (email/password + magic link), magic link callback handler, user menu with sign-out, and integrate auth state into the App header. After this plan, users can create accounts, sign in, and sign out.

Purpose: Delivers AUTH-01 (sign up), AUTH-02 (magic link sign in), AUTH-03 (session persistence -- built-in via Supabase), and the sign-out flow. These are the user-facing auth features.
Output: Four new components in `src/components/auth/`, App.tsx updated with auth-aware header.
</objective>

<execution_context>
@/Users/walterjooste/.claude/get-shit-done/workflows/execute-plan.md
@/Users/walterjooste/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-authentication-foundation/01-RESEARCH.md
@.planning/phases/01-authentication-foundation/01-01-SUMMARY.md
@src/App.tsx
@src/lib/supabase.ts
@src/contexts/auth-context.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build auth form components and magic link callback</name>
  <files>
    src/components/auth/signup-form.tsx
    src/components/auth/login-form.tsx
    src/components/auth/auth-callback.tsx
  </files>
  <action>
Create three components in `src/components/auth/`. Follow existing codebase conventions: named exports, PascalCase components, props interfaces, Tailwind styling with `cn()`, use `@/` import alias, use existing UI primitives from `@/components/ui/` (Button, Input, Card).

**`src/components/auth/signup-form.tsx` -- SignUpForm:**
- Form with three fields: display name (text), email, password
- On submit, call `supabase.auth.signUp({ email, password, options: { data: { display_name }, emailRedirectTo: \`\${window.location.origin}/auth/callback\` } })`
- Show loading state on submit button while request is in flight
- Show error message if signup fails (use Supabase error.message)
- Show success message: "Account created! You can now sign in." (if email confirmation is disabled, user is auto-signed-in via onAuthStateChange)
- Include a "Already have an account? Sign in" link/button that calls an `onToggle` callback prop to switch to login form
- Props: `onToggle: () => void` (switches to login view), `onSuccess?: () => void` (called after successful signup)

**`src/components/auth/login-form.tsx` -- LoginForm:**
- Form with two fields: email, password
- Two submit paths:
  1. "Sign in" button: calls `supabase.auth.signInWithPassword({ email, password })`
  2. "Send magic link" button: calls `supabase.auth.signInWithOtp({ email, options: { emailRedirectTo: \`\${window.location.origin}\`, shouldCreateUser: false } })`. Note: magic link redirects to app root (not /auth/callback) because we handle token_hash at the root level.
- Show loading state on whichever button was clicked
- Show error message if either action fails
- For magic link success, show: "Check your email for a sign-in link"
- Include a "Don't have an account? Sign up" link/button that calls `onToggle`
- Props: `onToggle: () => void`, `onSuccess?: () => void`

**`src/components/auth/auth-callback.tsx` -- AuthCallback:**
- On mount, parse `window.location.search` for `token_hash` and `type` parameters
- If both present, call `supabase.auth.verifyOtp({ token_hash, type: type as 'email' })`
- On success, clean URL with `window.history.replaceState({}, '', window.location.pathname)`
- On error, display error message
- While verifying, show a loading indicator
- If no token_hash params present, render nothing (return null)
- This component will be mounted in App.tsx to handle magic link redirects

Style all forms to match the existing app aesthetic: use `glass-card` class for form containers, existing Button/Input components, `text-primary` for links, `text-destructive` for errors. Forms should be compact and centered, working well on mobile.

Do NOT use `@supabase/auth-ui-react` (unmaintained per research). Build custom forms.
  </action>
  <verify>
Run `npm run build` -- zero TypeScript errors. All three files exist and export their named components. Verify imports resolve correctly (supabase client, UI components, auth-context).
  </verify>
  <done>
Three auth components exist: SignUpForm (email/password/display_name signup), LoginForm (password signin + magic link), AuthCallback (token_hash verification). All compile without errors. Forms use existing UI primitives and match app styling.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create user menu and integrate auth into App header</name>
  <files>
    src/components/auth/user-menu.tsx
    src/App.tsx
  </files>
  <action>
**Create `src/components/auth/user-menu.tsx` -- UserMenu:**
- Displays the authenticated user's display name (from `user.user_metadata.display_name` or fallback to email)
- Shows a "Sign out" button that calls `signOut` from useAuth
- Shows loading state while sign-out is in progress
- Simple, compact design: user name + sign out button in a row
- Props: none (uses useAuth hook internally)

**Modify `src/App.tsx`:**

1. Add `AuthCallback` component mount: Place `<AuthCallback />` near the top of the return JSX (before the header). This ensures magic link token_hash is processed on any page load.

2. Modify the header area to be auth-aware:
   - Import `useAuth` from `@/contexts/auth-context`
   - Import `UserMenu` from `@/components/auth/user-menu`
   - Import `LoginForm` and `SignUpForm` from their respective files
   - Add state: `const [showAuth, setShowAuth] = useState<'login' | 'signup' | null>(null)`
   - Get `{ user, loading: authLoading }` from `useAuth()`
   - In the header section (where "Find Paulina a Movie" h1 is), add to the right side:
     - If `authLoading`: show nothing or a subtle skeleton
     - If `user`: show `<UserMenu />`
     - If `!user`: show a "Sign in" button that sets `showAuth` to `'login'`
   - When `showAuth` is not null, render a modal/overlay with the appropriate form:
     - Use a simple overlay div with glass-card styling
     - `showAuth === 'login'` renders `<LoginForm onToggle={() => setShowAuth('signup')} onSuccess={() => setShowAuth(null)} />`
     - `showAuth === 'signup'` renders `<SignUpForm onToggle={() => setShowAuth('login')} onSuccess={() => setShowAuth(null)} />`
     - Include a close/dismiss button or click-outside-to-close
   - When user signs in (onAuthStateChange fires, user becomes non-null), auto-close the auth modal by watching user state

3. Keep the existing title "Find Paulina a Movie" and all existing functionality intact. The auth UI is additive -- do not remove or reorganize existing features.

4. Handle the auto-close: add a `useEffect` that watches `user` -- when user becomes non-null and `showAuth` is set, set `showAuth(null)`.

Keep the app title and all movie browsing functionality exactly as-is. Auth is an addition to the header area, not a replacement of anything.
  </action>
  <verify>
Run `npm run build` -- zero TypeScript errors. Verify that App.tsx imports and uses AuthCallback, UserMenu, LoginForm, SignUpForm, and useAuth. Verify the auth modal state management exists. Verify existing movie browsing code is untouched (search, filters, sort, table/card rendering).
  </verify>
  <done>
UserMenu component exists showing display name + sign out. App.tsx has: AuthCallback mounted for magic link handling, conditional header (sign-in button for anon, UserMenu for authenticated), auth modal with login/signup forms that toggle between each other. All existing movie browsing functionality preserved. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` compiles with zero errors
2. Four new files exist in `src/components/auth/`: signup-form.tsx, login-form.tsx, auth-callback.tsx, user-menu.tsx
3. App.tsx imports and mounts AuthCallback, shows conditional auth header
4. SignUpForm calls supabase.auth.signUp with display_name in metadata
5. LoginForm calls both signInWithPassword and signInWithOtp
6. AuthCallback parses token_hash and calls verifyOtp
7. UserMenu shows user display name and sign-out button
8. Existing movie browsing UI is unchanged
</verification>

<success_criteria>
- Anonymous users see "Sign in" button in header, can browse movies normally
- Sign-up form collects display name, email, password and calls supabase.auth.signUp
- Login form supports both password sign-in and magic link
- AuthCallback processes magic link redirect (token_hash verification)
- Authenticated users see their name and sign-out button
- Sign-out returns user to anonymous state
- Session persists across browser refresh (built-in Supabase behavior, AuthProvider restores session on mount)
- All forms show loading states and error messages
- Build succeeds with zero TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-foundation/01-02-SUMMARY.md`
</output>
